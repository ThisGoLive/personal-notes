# 数据库事务

2019年7月7日21:48:01

## 数据库 四大特性：

+ 原子性   事务时应用中最小的执行单位，全部操作 与 数据库中不可分割，全部执行 或者 全部不执行
+ 一致性   几个并行执行的事务，其执行结果必须 与 按照 某一顺序执行的结果相同
+ 隔离性  各个事务之间 互不干扰，事务执行的中间结果 对 其他事务必须透明
+ 持久性   事务一但提交，对数据的所有操作 记录 都物理数据库中，保证不被丢失

事务的 ACID 以上四个特性，由关系形数据库实（DBMS）现。

> DBMS 采用日志来保证事务的原子性、一致性、持久性。日志记录了事务对数据库所做的更新，如果某个事务在执行过程中发生错误，就可以过根据日志，撤销事务对数据库已做的更新，执行回滚。

> 对事务的隔离性，DBMS 采用 锁的机制 实现。当多个事务同时进行数据更新时，只允许 持有锁的事务更新该数据，其他事务必须等待，直到前一个事务释放类锁，其他事务才能进行更新数据。

## 事务隔离不完全，导致并发问题：

+ **更新丢失** ： 当两个事务同时更新同一数据，由于某一事务的撤销，导致另一事务对事件的修改也失效了，这就是更新丢失。
+ **脏读** ： 一个事务读取到另一个事务还没有提交，但已经更改的数据。这种情况下数据可能不一致。
+ **不可重复读** ： 当一个事务读取了某些数据后，另外一个事务修改了这些数据，并提交了。这个事务再去读取时发现，数据和之前的不同。
+ **幻读** ： 同一查询在同一事务中多次进行，但由于其他事务的插入，导致每次读取的数据都不同。可以理解为 不可重复读的一种。 **幻读** 第二次读时，数据有新增。**不可重读**第二次读时，数据 有更新 或者减少。

大致理解：

1. A事务更新数据时，数据 被 B事务 撤销了。所以 更新失败
2. A 事务 读数据时，读到了 B 事务，修改还没提交的数据，如果 此时 B 撤销了更新，A 事务 就脏读了没有提交的数据。
3. A 事务 读取后，B事务 对数据进行更新，导致 A 再读 时，两次数据不同。
4. A 事务 读取后，B事务 对数据新增，导致 A 再读 时，两次数据集不同。

## 隔离级别

因为事务 之间隔离级别的存在，对于具有相同输入、相同执行流程的事务可能产生不同的执行结果

数据隔离性越高，数据越准确，并发性能越低。

ANSI/ISO  SQL 92定义的 隔离级别：

+ **序列化** ： 所有事务之间完全隔离。所有事务 不能并发执行。事务完全隔离
+ **可重复读**： 所有的 Select 语句 读取的数据都不能被修改。
+ **读已提交**：读取数据的事务预先其他事务继续访问它正读取的数据，但是 **未提交的写事务** 将禁止其他事务正在写的数据。
+ **读未提交** ： 如果一个事务正在写数据，不允许其他事务写，但允许 其他事务读取它正在写的数据。故而 一个事务 可能 读取到 其他事务 未提交 的数据。（脏读）

| 隔离级别 | 更新丢失 | 脏读                                                             | 不可重复读                                          | 幻读               |
| ---- | ---- | -------------------------------------------------------------- | ---------------------------------------------- | ---------------- |
| 序列化  | 不发生  | 不发生                                                            | 不发生                                            | 不发生              |
| 可重复读 | 不发生  | 不发生                                                            | 不发生                                            | 读就数据时，可以新增数据（发生） |
| 读已提交 | 不发生  | 不发生                                                            | A 事务读的数据 ，可以被 B事务写，但是 B事务没有提交，不允许其他事务再读该数据（发生） |                  |
| 读未提交 | 不发生  | A 事务 正在写数据，还没提交，不允许 他去事务 也来写数据，放在 更新丢丢失，但允许 其他事务来读还没提交的数据。（发生） |                                                |                  |

以上全部 都是 在 一个事务执行过程中的。例如 ： A事务整个过程可能要读甲数据5次，第一次 读取 到 甲数据 被B 修改后没提交的数据，在 第一 与第二次之间，B事务 执行回滚 或者 数据修改，导致 第二次 读取 与第一次不同。