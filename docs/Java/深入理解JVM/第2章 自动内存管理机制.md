[[TOC]]

# 第二章 自动内存管理机制

## 2.1 运行时数据区域

书中是以 Java 虚拟机规范 7版本为例。

+ 程序技术器
+ 虚拟机栈
+ 本地方法栈
+ 堆
+ 方法区
+ 常量池
+ 直接内存（本机内存）

### 2.1.1 程序技术器

非常小的一块内存，用于 当前线程执行字节码指示器。每个线程私有。

唯一一个 不会出现 `OutOfMemoryError`的区域。

### 2.1.2 Java 虚拟机栈

1. 线程情况：每个线程私有
2. 生命周期：与线程同生命周期
3. 作用：描述 Java 中函数的 内存模型
4. 描述：每个方法执行时，都会创建一个 栈帧（Stack Frame）,用于方法内的 需要的内存信息。

-Xoss 设置本地方法栈容量 （HotSpot 无效）

-Xss 设置栈容量

线程请求的 栈深度 大于 虚拟机允许的栈深度 `StackOverflowError`

虚拟机栈 动态扩展时，无法申请到足够的内存 `OutOfMemoryError`

### 2.1.3 本地方法栈

基本与 Java 虚拟机栈 类似。只不过 放的 是本地方法 `Natice`服务

在 `HotSpot` 中 放在一起的。统称为栈。

### 2.1.4 Java堆 （heap）

Java 虚拟机中 管理的最大的一块内存区域。

1. 线程情况：所有线程公用
2. 生命周期：虚拟机启动时 创建
3. 作用：存放实例对象
4. 描述：只要 逻辑连续的内存即可

-Xms -Xmx 设置堆的大小    

内存不足时 `OutOfMemoryError`

引用类型：句柄池 于 直接指针

### 2.1.5 方法区

1. 线程情况：所有线程公用
2. 生命周期：虚拟机启动时 创建
3. 作用：存放 虚拟机加载的类信息、常量、静态变量、及时编译后的代码等数据

注 ： 在 Java 8 开始，方法区（Permanent Generation）就不再存在于虚拟机中，而是放在物理内存中 （Metaspace）

-XX:MaxParmSize 上限。

### 2.1.6 常量池

是方法区的一部分。

### 2.1.7 直接内存

不是 Java 虚拟机运行时数据区的一部分，也不是 Java 虚拟机规范定义的区域。如果这部分内存被频繁的使用，会出现 `OutOfMemoryError`

NIO （New Input/Output），就是直接 使用 Native 函数库直接分配对外内存。

