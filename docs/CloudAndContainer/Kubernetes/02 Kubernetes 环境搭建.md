[[TOC]]

# 02 搭建方式

[教程](https://kuboard.cn/learning/)

目前，Kubernetes    支持在多种环境下使用，包括本地主机（Fedora）、云服务 （Google    GAE、AWS    等）。
你可以使用以下几种方式部署    Kubernetes：

1. kubeadm 
2. docker-desktop 
3. k3s

## kubeadm

kubeadm 可用于快速部署一套 kubernetes 集群。但是 生成环境 未保证。

```shell
# 创建 一个 master 节点
kubeadm init

# 将一个 node 节点加入到集群中
kubeadm join <master节点的 IP 端口>
```

由于 Kubernetes 不支持，swap 分区，故而 Linux 中 禁用 swap分区。

```shell
# 禁用命令
sudo swapoff -a

# 启用命令
sudo swapon -a

# 查看交换分区的状态
sudo free -m

# 把根目录文件系统设为可读写
sudo mount -n -o remount,rw /

# 用vi修改/etc/fstab文件，在swap分区这行前加 # 禁用掉，保存退出
vi /etc/fstab
i      #进入insert 插入模式
:wq   #保存退出
# 重新启动电脑，使用free -m查看分区状态

reboot
sudo free -m
```

### kubelet

用于管理容器，创建容器，但是现在 没法实现 在容器中运行，只能在宿主机上运行。应为 它的功能性质，需要操作宿主机中的文件，很难实现，在容器中操作宿主机。

### kubectl

kubernetes 的客户端

### 安装kubeadm，kubelet和kubectl

https://juejin.cn/post/7032845652606320653

```shell
sudo apt-get update &&apt-get install -yapt-transport-https
# su root 
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -

# https://mirrors.aliyun.com/kubernetes/apt/kubernetes-xenial main 
cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list 
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF
sudo apt-get update
```

镜像 https://www.jianshu.com/p/d42ef0eff63f

```shell
# 查看版本
apt-cache madison  kubeadm kubelet kubectl
# 设置版本下载
apt-get install -y kubelet=1.23.5-00 kubeadm=1.23.5-00 kubectl=1.23.5-00
# 设置标签
# sudo apt-mark hold kubelet=1.22.4-00 kubeadm=1.22.4-00 kubectl=1.22.4-00
apt-get install -y kubelet kubeadm kubectl

# 设置开启启动 kubelet 并 运行 kubelet
sudo systemctl enable kubelet && sudo systemctl start kubelet

#https://kubernetes.io/zh/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/
#配置 kubelet 的 cgroup 驱动
kubeadm-config.yaml
kind: ClusterConfiguration
apiVersion: kubeadm.k8s.io/v1beta3
kubernetesVersion: v1.23.5
---
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
cgroupDriver: systemd

# 获取镜像
kubeadm config images pull --image-repository  registry.aliyuncs.com/google_containers
kubeadm init --config=kubeadm-config.yaml 
```

### 修改内核的运行参数

```shell
cat    <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables = 1 
net.ipv4.ip_forward = 1 
net.bridge.bridge-nf-call-ip6tables = 1 
EOF

sudo sysctl --system
```

### 配置 kubelet

```shell
sudo vim /etc/systemd/system/kubelet.service.d/10-proxy-ipvs.conf
[Service] 
ExecStartPre=-modprobe ip_vs
ExecStartPre=-modprobe ip_vs_rr
ExecStartPre=-modprobe ip_vs_wrr
ExecStartPre=-modprobe ip_vs_sh


sudo systemctl daemon-reload
```

### master

```shell
sudo kubeadm init --image-repository registry.aliyuncs.com/google_containers \
--pod-network-cidr 10.244.0.0/16 \
--v 5 \
--ignore-preflight-errors=all

# 成功后末尾出现
kubeadm join 192.168.100.103:6443 --token 976mnk.zjvxfv8qjmxb3bvd \
    --discovery-token-ca-cert-hash sha256:595f81629ccec7b18128857dfc60ed8cdd9938f0a74963592da7ea5c07236d4b
# 出现不能访问
vim /etc/profile
export KUBECONFIG=/etc/kubernetes/admin.conf
source /etc/profile
```

### node

```shell
sudo kubeadm join 192.168.100.103:6443 --token 976mnk.zjvxfv8qjmxb3bvd \
    --discovery-token-ca-cert-hash sha256:595f81629ccec7b18128857dfc60ed8cdd9938f0a74963592da7ea5c07236d4b
```

```shell
# 1.查看当前的token列表
kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
7mjtn4.9kds6sabcouxaugd   23h         2019-12-24T15:44:58+08:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token

# 2.重新生成新的token
kubeadm token create
369tcl.oe4punpoj9gaijh7

# 3.再次查看当前的token列表
kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
369tcl.oe4punpoj9gaijh7   23h         2019-12-24T16:05:18+08:00   authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token
7mjtn4.9kds6sabcouxaugd   23h         2019-12-24T15:44:58+08:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token

# 4.获取ca证书sha256编码hash值
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
7ae10591aa593c2c36fb965d58964a84561e9ccd416ffe7432550a0d0b7e4f90

# 5.节点加入集群
kubeadm join --token 369tcl.oe4punpoj9gaijh7(新的token) --discovery-token-ca-cert-hash sha256:7ae10591aa593c2c36fb965d58964a84561e9ccd416ffe7432550a0d0b7e4f90(ca证书sha256编码hash值) 172.22.34.31:6443 --skip-preflight-chec
```

### 服务

所有服务启动后，查看本地实际运行的Docker容器。这些服务大致分为三类：

+ 主节点服务
+ 工作节点服务
+ 其他服务

#### 主节点服务

apiserver： 整个系统对外接口，提供 RESTful 供客户端 和其他组件调用

scheduler ： 调度，分配pod 到 节点上

controller-manager 赋值 管理控制， endpoint-controller 刷新服务 和 pod关联信息  replication-controller 维护 某个 pod 的复制 配置的数值

#### 工作节点服务

proxy 为 pod上的服务提供访问代理

#### 其他服务

etcd 是所有状态的存储数据库

将 /etc/kubernetes/admin.conf 复制到 ~/.kube/config

```shell
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubectl get all -A
```

执行 `kubectl get all -A`查看启动的服务。

### 部署 CNI

为部署 CNI插件， CoreDNS 未正常启动。

检查 podCIDR 设置

```shell
kubectl get node -o yaml | grep CIDR
```

```shell
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml
```

### 默认 Master 不能运行pod

如果 部署一个 单节点集群。默认就不能使用 需要解除 master 限制

```shell
kubectl taint nodes --all node-role.kubernetes.io/master-
# 恢复 限制
kubectl    taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule
```

## Docker Desktop 启用 Kubernetes

## 变更IP

当宿主机器 重启后，docker 容器中运行的 k8s 服务 都没有关闭。

但是 master 中IP变更了， `kubectl get nodes` 是无法执行的。

### 问题一 6443服务拒绝

[解决思路](https://www.jianshu.com/p/6edc9f171df1)

The connection to the server 192.168.100.107:6443 was refused - did you specify the right host or port?

```shell
# 查看 服务开启问题
netstat -pnlt | grep 6443
# 查看容器 apiserver
docker ps -a | grep apiserver
```

### 问题二 证书问题

Unable to connect to the server: x509: certificate signed by unknown authority (possibly because of "crypto/rsa: verification error" while trying to verify candidate authority certificate "kubernetes"

```shell
 # 生成证书
 sudo kubeadm init phase certs apiserver  --apiserver-advertise-address 192.168.100.107
```

但是这个问题，并不是 证书造成的

```shell
# 查看 当前配置
kubectl config view
# 删除
kubectl config delete-cluster kubernetes
# 感觉 还是 配置文件的问题
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### 问题三 8080服务拒绝

The connection to the server localhost:8080 was refused - did you specify the right host or port

这个 貌似是 `/etc/kubernetes/admin.conf`  的原因。不能删除 `kubectl config delete-cluster kubernetes`

### 问题四 无法连接服务

Unable to connect to the server: dial tcp: lookup k8-master on 127.0.0.53:53: server misbehaving

当 master 重启后，IP 变了， 修改了 中IP 为 hostname ,造成

```shell
sudo vim /etc/kubernetes/admin.conf  
sudo vim /etc/kubernetes/controller-manager.conf  
sudo vim /etc/kubernetes/scheduler.conf 
sudo vim ./.kube/config
```

```shell
journalctl -f -u kubelet.service

168.100.107:6443: connect: connection refused
Mar 28 07:09:40 k8s-master kubelet[17820]: E0328 07:09:40.546185   17820 kubelet.go:2263] node "k8s-master" not found
Mar 28 07:09:40 k8s-master kubelet[17820]: E0328 07:09:40.647179   17820 kubelet.go:2263] node "k8s-master" not found
Mar 28 07:09:40 k8s-master kubelet[17820]: E0328 07:09:40.720892   17820 reflector.go:153] k8s.io/kubernetes/pkg/kubelet/kubelet.go:458: Failed to list *v1.Node: Get https://192.168.100.107:6443/api/v1/nodes?fieldSelector=metadata.name%3Dk8s-master&limit=500&resourceVersion=0: dial tcp 192.168.100.107:6443: connect: connection refused

# 最终 还是 kubectl config view 时， ./.kube/config 的问题，
# 重新生成/etc/kubernetes/admin.conf   再复制
kubeadm init phase kubeconfig admin --apiserver-advertise-address <新的ip>
```

### 问题五 network plugin is not ready: cni config uninitialized

部署 CNI， 安装 flannel

```shell
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

### 问题六 connect to the server: x509: certificate signed by unknown authority

```shell
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### Master IP变化

1. 修改/etc/kubernetes/文件夹里的*.conf文件，把这些文件中有旧IP的地方全都替换成你的新IP。  
2. 修改$HOME/.kube/config文件，操作同上。
3. 进入$HOME/.kube/cache/discovery/，这里应该有个子文件夹名字是“你的.旧.IP.地址_6443”（如127.0.0.1_6443），把这个文件夹名字里的IP改成你新IP。
4. 重新生成证书然后重启即可 `kubeadm token create`
   k8s-master 192.168.100.100

```shell
sudo vim /etc/kubernetes/admin.conf  
sudo vim /etc/kubernetes/controller-manager.conf  
sudo vim /etc/kubernetes/scheduler.conf 
sudo vim ./.kube/config
sudo mv ./.kube/cache/discovery/192.168.100.103_6443/ ./.kube/cache/discovery/192.168.100.107_6443/
```

```shell
sudo mv /etc/kubernetes/pki/apiserver.key /etc/kubernetes/pki/apiserver.key.old
sudo mv /etc/kubernetes/pki/apiserver.crt /etc/kubernetes/pki/apiserver.crt.old
sudo mv /etc/kubernetes/pki/apiserver-kubelet-client.crt /etc/kubernetes/pki/apiserver-kubelet-client.crt.old
sudo mv /etc/kubernetes/pki/apiserver-kubelet-client.key /etc/kubernetes/pki/apiserver-kubelet-client.key.old
sudo mv /etc/kubernetes/pki/front-proxy-client.crt /etc/kubernetes/pki/front-proxy-client.crt.old
sudo mv /etc/kubernetes/pki/front-proxy-client.key /etc/kubernetes/pki/front-proxy-client.key.old

sudo cp /etc/kubernetes/pki/apiserver.key.old /etc/kubernetes/pki/apiserver.key
sudo cp /etc/kubernetes/pki/apiserver.crt.old /etc/kubernetes/pki/apiserver.crt
sudo cp /etc/kubernetes/pki/apiserver-kubelet-client.crt.old /etc/kubernetes/pki/apiserver-kubelet-client.crt
sudo cp /etc/kubernetes/pki/apiserver-kubelet-client.key.old /etc/kubernetes/pki/apiserver-kubelet-client.key
sudo cp /etc/kubernetes/pki/front-proxy-client.crt.old /etc/kubernetes/pki/front-proxy-client.crt
sudo cp /etc/kubernetes/pki/front-proxy-client.key.old /etc/kubernetes/pki/front-proxy-client.key

# 生成证书
kubeadm init phase certs apiserver  --apiserver-advertise-address <新的ip>
```

[改变MasterIP](https://www.cnblogs.com/chaojiyingxiong/p/12106590.html)

```shell
 # 查找 那些文件中 有 旧IP
 sudo find /etc/kubernetes -type f |xargs grep 192.168.100.107 |awk '{print $1}' |sort |uniq

# 修改为新IP 192.168.100.100
sudo vim /etc/kubernetes/manifests/etcd.yaml
sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml
# master 节点IP
sudo vim /etc/kubernetes/kubelet.conf
# 生成新的 admin.conf
sudo mv /etc/kubernetes/admin.conf /etc/kubernetes/admin.conf.old
sudo kubeadm init phase kubeconfig admin --apiserver-advertise-address 192.168.100.100

sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 生成新证书
sudo mv /etc/kubernetes/pki/apiserver.key /etc/kubernetes/pki/apiserver.key.old
sudo mv /etc/kubernetes/pki/apiserver.crt /etc/kubernetes/pki/apiserver.crt.old
sudo kubeadm init phase certs apiserver  --apiserver-advertise-address 192.168.100.100

# 重启
service docker restart
service kubelet restart

# 查看 问题
journalctl -f -u kubelet
journalctl -f -u kubelet.service
```

## 节点增删

```shell
kubeadm token list
# 每个token只有24小时的有效期，如果没有有效的token
kubeadm token create
# 查看 token 加密的字符串
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'

sudo kubeadm join 192.168.100.100:6443 --token f0ty2j.8n5a7ursabj2x9ky --discovery-token-ca-cert-hash sha256:409bc68a614691135a1ff7252246cb5cfe0b88f9d21364ed6e65f14081ee3104

# 重新生成加入命令
kubeadm token create --print-join-command
```

```shell
kubectl get nodes -o wide
kubectl describe node k8s-master
```

```shell
# master node 重置
kubeadm reset
# 会发现 master 虽然都已经改了，但还是 会出 老IP，导致 join 报错
kubectl -n kube-system get cm kubeadm-config -oyaml

# 查看 finnnal 拉去, node 在 join 后会自动执行
docker images | grep flannel

# 查看 pod
kubectl get pods --all-namespaces
```
